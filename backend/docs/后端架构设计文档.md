# AI角色扮演系统后端架构设计文档

## 1. 项目概述

### 1.1 项目简介
AI角色扮演系统是一个基于Spring Boot WebFlux的响应式Web应用，提供AI驱动的角色扮演聊天服务。系统支持文本和语音交互，用户可以与预设的AI角色进行多轮对话，体验沉浸式的角色扮演交互。

### 1.2 技术栈
- **框架**: Spring Boot 3.4.10 + Spring WebFlux
- **编程语言**: Java 17
- **数据库**: MySQL 8.0
- **缓存**: Redis
- **ORM**: MyBatis Plus 3.5.5
- **安全**: Spring Security + JWT
- **文档**: SpringDoc OpenAPI 3
- **云服务**: 七牛云 (AI服务 + 对象存储)
- **构建工具**: Maven

### 1.3 系统特性
- 响应式编程架构，支持高并发
- 多角色AI对话系统
- 文本与语音双模态交互
- 流式响应，实时对话体验
- 分布式缓存优化
- RESTful API设计
- 完整的用户认证授权体系

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   后端服务      │    │   外部服务      │
│   (React)       │◄──►│  (Spring Boot)  │◄──►│  (七牛云AI)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   数据存储      │
                       │ MySQL + Redis   │
                       └─────────────────┘
```

### 2.2 分层架构
系统采用经典的分层架构模式：

**表现层 (Controller Layer)**
- 处理HTTP请求和响应
- 参数验证和数据转换
- API文档生成

**业务逻辑层 (Service Layer)**
- 核心业务逻辑实现
- 事务管理
- 缓存策略

**数据访问层 (Mapper Layer)**
- 数据库操作封装
- SQL映射管理

**基础设施层 (Infrastructure Layer)**
- 配置管理
- 安全控制
- 工具类和常量

## 3. 核心模块设计

### 3.1 用户认证模块 (Authentication Module)

**功能职责:**
- 用户注册、登录、登出
- JWT令牌生成和验证
- 密码加密存储

**核心组件:**
- `AuthController`: 认证相关API接口
- `UserService`: 用户业务逻辑
- `JwtUtils`: JWT工具类
- `SecurityConfig`: 安全配置
- `JwtAuthenticationFilter`: JWT认证过滤器

**技术实现:**
- 使用BCrypt进行密码哈希
- JWT令牌有效期24小时，刷新令牌7天
- Spring Security WebFlux集成

### 3.2 AI角色管理模块 (Character Management Module)

**功能职责:**
- AI角色信息管理
- 角色技能系统
- 角色开场白生成

**核心组件:**
- `CharacterController`: 角色管理API
- `CharacterService`: 角色业务逻辑
- `CharacterSkillService`: 技能管理服务
- `CharacterOpeningInitializer`: 开场白初始化

**数据模型:**
- `AiCharacter`: 角色基本信息
- `CharacterSkill`: 角色特殊技能

**特色功能:**
- 支持动漫、影视、历史、科普四大角色分类
- 每个角色配置独特的系统提示词和语音配置
- 角色技能系统，支持特殊能力触发

### 3.3 对话管理模块 (Conversation Management Module)

**功能职责:**
- 对话会话管理
- 消息存储和检索
- 对话上下文维护

**核心组件:**
- `ConversationController`: 对话管理API
- `ConversationService`: 对话业务逻辑
- `MessageService`: 消息管理服务
- `ConversationCacheService`: 对话缓存服务

**数据模型:**
- `Conversation`: 对话会话信息
- `Message`: 消息记录

**缓存策略:**
- Redis缓存对话上下文，30分钟过期
- 支持对话历史的快速检索

### 3.4 AI聊天模块 (AI Chat Module)

**功能职责:**
- AI对话接口封装
- 流式响应处理
- 多轮对话上下文管理

**核心组件:**
- `AiChatController`: AI聊天API
- `AiRoleplayService`: 核心角色扮演服务
- `QiniuAiService`: 七牛云AI服务封装

**技术特点:**
- 支持单次对话和多轮对话
- 流式响应，实时返回AI生成内容
- 智能上下文管理，保持对话连贯性

### 3.5 语音处理模块 (Audio Processing Module)

**功能职责:**
- 语音识别 (ASR)
- 语音合成 (TTS)
- 音频文件管理

**核心组件:**
- `QiniuAudioService`: 音频处理服务
- `FileUploadController`: 文件上传API
- `FileStorageService`: 文件存储服务

**技术实现:**
- 集成七牛云ASR和TTS服务
- 支持多种音频格式
- 音频文件云端存储

### 3.6 文件管理模块 (File Management Module)

**功能职责:**
- 文件上传下载
- 云端存储管理
- 静态资源服务

**核心组件:**
- `QiniuUploadService`: 七牛云上传服务
- `QiniuKodoConfig`: 对象存储配置

## 4. 数据库设计

### 4.1 数据模型概览
系统采用MySQL作为主数据库，设计了5个核心表：

### 4.2 核心表结构

**用户表 (user)**
- 存储用户基本信息
- 支持逻辑删除
- 用户名唯一约束

**角色表 (characters)**
- 存储AI角色详细信息
- 包含系统提示词、语音配置等
- 支持角色分类和标签

**对话表 (conversations)**
- 记录用户与角色的对话会话
- 外键关联用户和角色
- 支持对话状态管理

**消息表 (messages)**
- 存储具体的对话消息
- 支持文本和音频两种内容类型
- 记录发送者类型（用户/角色）

**角色技能表 (character_skills)**
- 定义角色的特殊技能
- 每个技能包含触发提示词
- 支持技能描述和管理

### 4.3 数据关系
- 用户与对话：一对多关系
- 角色与对话：一对多关系
- 对话与消息：一对多关系
- 角色与技能：一对多关系

## 5. 缓存架构

### 5.1 缓存策略
系统采用Redis作为分布式缓存，实现多层缓存策略：

**角色开场白缓存**
- 缓存键：`ai:opening:{characterId}:text/audio`
- 过期时间：24小时
- 减少重复的AI调用

**对话上下文缓存**
- 缓存键：`ai:context:{conversationId}`
- 过期时间：30分钟
- 提升多轮对话响应速度

**用户会话缓存**
- JWT令牌黑名单管理
- 用户权限信息缓存

### 5.2 缓存更新策略
- 写入时更新 (Write-through)
- 定时清理过期数据
- 支持手动缓存刷新

## 6. 安全架构

### 6.1 认证机制
- JWT (JSON Web Token) 无状态认证
- 令牌包含用户ID和权限信息
- 支持令牌刷新机制

### 6.2 授权控制
- 基于Spring Security的细粒度权限控制
- API路径级别的访问控制
- 用户资源隔离

### 6.3 安全措施
- 密码BCrypt加密存储
- CORS跨域配置
- 请求频率限制
- SQL注入防护

## 7. 性能优化

### 7.1 响应式编程
- 基于Spring WebFlux的非阻塞I/O
- Reactor响应式流处理
- 提升系统并发能力

### 7.2 数据库优化
- 合理的索引设计
- 连接池配置优化
- 查询性能监控

### 7.3 缓存优化
- 多级缓存架构
- 缓存预热策略
- 缓存穿透防护

### 7.4 并发控制
- `ConcurrentControlService`实现并发限制
- 防止系统过载
- 优雅的降级处理

## 8. 监控与运维

### 8.1 系统监控
- `PerformanceMonitoringService`性能监控
- `MonitoringController`监控接口
- 系统健康检查

### 8.2 日志管理
- 结构化日志输出
- 不同级别的日志配置
- 日志文件轮转

### 8.3 配置管理
- 环境变量配置
- 配置文件分离
- 敏感信息保护

## 9. 部署架构

### 9.1 部署环境
- 支持Docker容器化部署
- 环境配置外部化
- 数据库连接池配置

### 9.2 扩展性设计
- 无状态服务设计
- 支持水平扩展
- 负载均衡友好

## 10. 开发规范

### 10.1 代码规范
- 统一的包结构组织
- 完整的异常处理机制
- 详细的API文档注解

### 10.2 数据库规范
- 统一的命名约定
- 逻辑删除标准
- 时间戳字段规范

### 10.3 接口规范
- RESTful API设计
- 统一的响应格式
- 完整的错误码体系

## 11. 项目分工建议

### 11.1 后端开发职责
**核心模块开发:**
- AI聊天引擎开发与优化
- 角色管理系统实现
- 语音处理模块集成
- 数据库设计与优化

**基础设施建设:**
- 安全认证体系搭建
- 缓存架构设计
- 性能监控系统
- 部署运维配置

**API接口开发:**
- RESTful API设计与实现
- 接口文档编写与维护
- 前后端联调支持

### 11.2 与前端协作
**接口协议制定:**
- API接口规范定义
- 数据格式标准化
- 错误处理机制统一

**联调测试:**
- 接口功能测试
- 性能压力测试
- 兼容性验证

## 12. 技术债务与优化方向

### 12.1 当前技术债务
- 部分业务逻辑可进一步解耦
- 缓存策略可优化
- 监控体系需完善

### 12.2 未来优化方向
- 引入消息队列处理异步任务
- 实现更细粒度的权限控制
- 增加系统指标监控
- 优化AI调用的成本控制

## 13. 总结

本AI角色扮演系统后端采用现代化的技术栈和架构设计，具备良好的可扩展性、可维护性和性能表现。通过响应式编程、分布式缓存、安全认证等技术手段，为用户提供流畅的AI角色扮演体验。

系统设计充分考虑了业务需求的复杂性和技术实现的可行性，为后续的功能扩展和性能优化奠定了坚实的基础。在实际开发过程中，建议按照模块化的方式进行开发，确保代码质量和项目进度的平衡。